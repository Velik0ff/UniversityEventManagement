extends layout

block content
    script.
        var original_list = !{JSON.stringify(list)};
        var list = !{JSON.stringify(list)};
        var filter_applied = false;
        var search_applied = false;

        function populateList(list) {
            $("tbody").empty();

            if (list.length > 0) {
                list.forEach(function (list_element) {
                    let tr = $("<tr>").appendTo('tbody');

                    for (let index in list_element) {
                        if (index === "id") {
                            $("<td>").attr('style', 'font-weight:bold').text(list_element[index]).appendTo(tr);
                        } else if (index === "name") {
                            let td = $("<td>").appendTo(tr);
                            $("<a>").attr('href', "#{viewLink}?id=" + list_element.id).text(list_element[index]).appendTo(td);
                        } else {
                            $("<td>").text(list_element[index]).appendTo(tr);
                        }
                    }

                    if("!{deleteLink}" !== "undefined" || "!{editLink}" !== "undefined"){
                        let td = $("<td>").appendTo(tr);

                        if ("!{editLink}" !== "undefined") {
                            let edit_a = $("<a>")
                                .attr("class", "options-btn")
                                .attr("href", "#{editLink}?id=" + list_element.id)
                                .attr("onclick", "return confirm('Are you sure you want to delete this entity?')").appendTo(td);
                            $("<i>").attr("class", "material-icons md-18").text("edit").appendTo(edit_a)
                        }
                        if("!{deleteLink}" !== "undefined"){
                            let delete_a = $("<a>")
                              .attr("class","options-btn")
                              .attr("href","#{deleteLink}?id="+list_element.id)
                              .attr("onclick","return confirm('Are you sure you want to delete this entity?')").appendTo(td);
                            $("<i>").attr("class","material-icons md-18").text("delete").appendTo(delete_a)
                        }
                    }
                });
            } else {
                let tr = $("<tr>").appendTo('tbody');
                $("<td>").attr('colspan', #{columns.length}).attr('align','center').text("No results to show").appendTo(tr);
            }
        }

        function searchFilter() {
            const input = $("#searchBox").val();

            function filterOutResults(object) {
                return object.id.includes(input) || object.name.includes(input);
            }

            if (input !== "") {
            	search_applied = true;

            	list = list.filter(filterOutResults);
                populateList(list);
            } else populateList(list);
        }
    if filter == "Events"
        script.
            function applyFilter(){
            	filter_applied = true;

            	let list_to_filter = list;

                if(!search_applied){
                    list_to_filter = original_list;
                }

                $.post("../filter", {
                    spacesMin:$("#rangeSpacesMin").val(),
                    spacesMax:$("#rangeSpacesMax").val(),
                    visitorsMin:$("#rangeVisitorsMin").val(),
                    visitorsMax:$("#rangeVisitorsMax").val(),
                    dateFrom:$("#rangeDateFrom").val(),
                    dateTo:$("#rangeDateTo").val(),
                    eventTypeSelected:$("#eventTypeSelectedFilter").val(),
                    list:list_to_filter,
                    type:!{JSON.stringify(type)}
                }, function (data) {
                    populateList(data.list);
                    list = data.list;
                });
            }
    else if filter == "Equipment"
        script.
            function applyFilter(){
            	filter_applied = true;

                function filterOutResults(object){
                	var result = true;

                	let qtyMin = $("#rangeQtyMin").val();
                    let qtyMax = $("#rangeQtyMax").val();

                	if(qtyMin && qtyMin >= object.quantity){
                      result = false;
                    }
                	if(qtyMax && qtyMax <= object.quantity){
                      result = false;
                    }

                	return result;
                }

                if(search_applied){
                	list = list.filter(filterOutResults);
                	populateList(list);
                } else {
                	list = original_list.filter(filterOutResults);
                	populateList(list);
                }
            }
    else if filter == "Rooms"
        script.
            function applyFilter(){
            	filter_applied = true;

                function filterOutResults(object){
                	var result = true;

                	let capacityMin = $("#rangeCapacityMin").val();
                    let capacityMax = $("#rangeCapacityMax").val();

                	if(capacityMin && capacityMin >= object.capacity){
                      result = false;
                    }
                	if(capacityMax && capacityMax <= object.capacity){
                      result = false;
                    }

                	return result;
                }

                if(search_applied){
                	list = list.filter(filterOutResults);
                	populateList(list);
                } else {
                	list = original_list.filter(filterOutResults);
                	populateList(list);
                }
            }

    if filter == "Events"
        script.
            function resetFilter(){
            	filter_applied = false;

                if(search_applied){
                	searchFilter();
                } else {
                	populateList(original_list);
                }

                $("#rangeSpacesMin").val("");
                $("#rangeSpacesMax").val("");
                $("#rangeVisitorsMin").val("");
                $("#rangeVisitorsMax").val("");
                $("#rangeDateFrom").val("");
                $("#rangeDateTo").val("");
            }
    else if filter == "Equipment"
        script.
            function resetFilter(){
            	filter_applied = false;

                if(search_applied){
                	searchFilter();
                } else {
                	populateList(original_list);
                }

                $("#rangeQtyMin").val("");
                $("#rangeQtyMax").val("");
            }
    else if filter == "Rooms"
        script.
            function resetFilter(){
            	filter_applied = false;

                if(search_applied){
                	searchFilter();
                } else {
                	populateList(original_list);
                }

                $("#rangeCapacityMin").val("");
                $("#rangeCapacityMax").val("");
            }

    .container
        h3.title=title
        if addLink
            a.btn.btn-success(href=addLink style="margin:5px;") Add New

        button.btn.btn-link#filterBtn Filter

        p
            div.row
                div.col-sm(style="padding-right:0")
                    input.form-control#searchBox(type="text" placeholder="Search by typing name or ID..")
                div.col-sm(style="flex-grow:0;padding-left:0")
                    button.btn.btn-primary(onclick="searchFilter()") Search


        div#filter(style="display:none;")
            h5="Filter Data"
            hr

            if filter == "Events"
                div#rangeSpaces
                    h6="Spaces Available"
                    div.row
                        div.col-sm
                            span="Minimum"
                            input.form-control#rangeSpacesMin(type="number")
                        div.col-sm
                            span="Maximum"
                            input.form-control#rangeSpacesMax(type="number")
                hr

                div#rangeVisitors
                    h6="Number of Visitors"
                    div.row
                        div.col-sm
                            span="Minimum"
                            input.form-control#rangeVisitorsMin(type="number")
                        div.col-sm
                            span="Maximum"
                            input.form-control#rangeVisitorsMax(type="number")
                hr

                div#rangeDate
                    h6="Dates"
                    div.row
                        div.col-sm
                            span="From"
                            input.form-control#rangeDateFrom(type="date")
                        div.col-sm
                            span="To"
                            input.form-control#rangeDateTo(type="date")
                hr

                div#eventTypeFilter
                    select#eventTypeSelectedFilter
                        each event_type in eventTypes
                            option(value=event_type._id)=event_type.typeName
                hr

            if filter == "Equipment"
                div#rangeQuantity
                    h6="Quantity"
                    div.row
                        div.col-sm
                            span="Minimum"
                            input.form-control#rangeQtyMin(type="number")
                        div.col-sm
                            span="Maximum"
                            input.form-control#rangeQtyMax(type="number")
                hr

            if filter == "Rooms"
                div#rangeCapacity
                    h6="Capacity"
                    div.row
                        div.col-sm
                            span="Minimum"
                            input.form-control#rangeCapacityMin(type="number")
                        div.col-sm
                            span="Maximum"
                            input.form-control#rangeCapacityMax(type="number")
                hr


            center
                button.btn.btn-primary(onclick="applyFilter()")="Apply Filter"
                button.btn.btn-primary(onclick="resetFilter()")="Reset Filter"

        table.table
            thead
                tr
                    each column in columns
                        th(scope='col')=column
            tbody
                if error
                    tr
                        td(colspan=columns.length align="center")=error
                each item in list
                    tr
                        each info,index in item
                            if index==="id"
                                td(style="font-weight:bold")=info
                            else if index==="name"
                                td
                                    a(href=viewLink+"?id="+item.id)=info
                            else
                                td=info
                        if deleteLink || editLink
                            td
                                if editLink
                                    a.options-btn(href=editLink+"?id="+item.id)
                                        i.material-icons.md-18 edit
                                if deleteLink
                                    a.options-btn(href=deleteLink+"?id="+item.id onclick="return confirm('Are you sure you want to delete this entity?')")
                                        i.material-icons.md-18 delete

    script.
        $("#filterBtn").on('click', function (event) {
            let filter_container = $("#filter");

            if (filter_container.css('display') == 'none') {
                filter_container.css('display', 'block');
            } else {
                filter_container.css('display', 'none');
            }
        });